<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –¥–æ—Ä–æ–≥ –∫–∞–º–ø—É—Å–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1c1c1e;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            margin-bottom: 20px;
            text-align: center;
        }
        .instructions {
            background: #2c2c2e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-bottom: 10px;
            color: #0a84ff;
        }
        .instructions ol {
            margin-left: 20px;
        }
        .instructions li {
            margin: 5px 0;
        }
        .map-container {
            position: relative;
            background: #f5f5f5;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        #editor-svg {
            display: block;
            width: 100%;
            height: auto;
            cursor: crosshair;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #0a84ff;
            color: white;
        }
        .btn-danger {
            background: #ff3b30;
            color: white;
        }
        .btn-success {
            background: #34c759;
            color: white;
        }
        .btn-secondary {
            background: #8e8e93;
            color: white;
        }
        button:hover {
            opacity: 0.8;
        }
        button:active {
            transform: scale(0.98);
        }
        .mode-indicator {
            background: #2c2c2e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
        }
        .mode-indicator.entrance { color: #34c759; }
        .mode-indicator.node { color: #0a84ff; }
        .mode-indicator.road { color: #ff9500; }
        .output {
            background: #2c2c2e;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .output h3 {
            margin-bottom: 10px;
            color: #0a84ff;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            background: #1c1c1e;
            color: #fff;
            border: 1px solid #3a3a3c;
            border-radius: 8px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }
        .road-line {
            stroke: #ff9500;
            stroke-width: 3;
            cursor: pointer;
        }
        .road-line:hover {
            stroke: #ff3b30;
            stroke-width: 5;
        }
        .point-marker {
            cursor: pointer;
        }
        .point-marker:hover circle {
            fill: #ff3b30;
        }
        .temp-line {
            stroke: #0a84ff;
            stroke-width: 2;
            stroke-dasharray: 5,5;
            pointer-events: none;
        }
        .stats {
            background: #2c2c2e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0a84ff;
        }
        .stat-label {
            font-size: 14px;
            color: #8e8e93;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ£Ô∏è –†–µ–¥–∞–∫—Ç–æ—Ä –¥–æ—Ä–æ–≥ –∫–∞–º–ø—É—Å–∞</h1>
        
        <div class="instructions">
            <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h3>
            <ol>
                <li><strong>–î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥ –Ω–∞ –∫–∞–º–ø—É—Å:</strong> –ù–∞–∂–º–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥", –∑–∞—Ç–µ–º –∫–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–µ (–≥–ª–∞–≤–Ω—ã–µ –≤—Ö–æ–¥—ã)</li>
                <li><strong>–î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª:</strong> –ù–∞–∂–º–∏ "–î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª", –∑–∞—Ç–µ–º –∫–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–µ (–¥–ª—è –ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–∫–æ–≤)</li>
                <li><strong>–î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥ –≤ –∫–æ—Ä–ø—É—Å:</strong> –ù–∞–∂–º–∏ "–í—Ö–æ–¥ –≤ –∫–æ—Ä–ø—É—Å", –∑–∞—Ç–µ–º –∫–ª–∏–∫–Ω–∏ –≥–¥–µ –¥–≤–µ—Ä—å –∫–æ—Ä–ø—É—Å–∞</li>
                <li><strong>–î–æ–±–∞–≤–∏—Ç—å –º–µ–¥–ø—É–Ω–∫—Ç:</strong> –ù–∞–∂–º–∏ "–ú–µ–¥–ø—É–Ω–∫—Ç", –∑–∞—Ç–µ–º –∫–ª–∏–∫–Ω–∏ –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –º–µ–¥–ø—É–Ω–∫—Ç</li>
                <li><strong>–ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –¥–æ—Ä–æ–≥—É:</strong> –ù–∞–∂–º–∏ "–†–∏—Å–æ–≤–∞—Ç—å –¥–æ—Ä–æ–≥–∏", –∑–∞—Ç–µ–º –∫–ª–∏–∫–∞–π –ø–æ —Ç–æ—á–∫–∞–º - –º–µ–∂–¥—É –Ω–∏–º–∏ –ø–æ—è–≤–∏—Ç—Å—è –¥–æ—Ä–æ–≥–∞</li>
                <li><strong>–£–¥–∞–ª–∏—Ç—å –¥–æ—Ä–æ–≥—É:</strong> –ù–∞–∂–º–∏ "–£–¥–∞–ª–∏—Ç—å –¥–æ—Ä–æ–≥—É", –∑–∞—Ç–µ–º –∫–ª–∏–∫–Ω–∏ –Ω–∞ –ª–∏–Ω–∏—é</li>
                <li><strong>–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É:</strong> –ù–∞–∂–º–∏ "–£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É", –∑–∞—Ç–µ–º –∫–ª–∏–∫–Ω–∏ –Ω–∞ —Ç–æ—á–∫—É (—É–¥–∞–ª—è—Ç—Å—è –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ—Ä–æ–≥–∏)</li>
                <li><strong>–≠–∫—Å–ø–æ—Ä—Ç:</strong> –ù–∞–∂–º–∏ "–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å" - —Å–∫–æ–ø–∏—Ä—É–π –∫–æ–¥ –∏ –≤—Å—Ç–∞–≤—å –≤ map-script.js</li>
            </ol>
        </div>

        <div class="mode-indicator" id="mode-indicator">
            –†–µ–∂–∏–º: –ü—Ä–æ—Å–º–æ—Ç—Ä
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="entrance-count">0</div>
                <div class="stat-label">–í—Ö–æ–¥–æ–≤ –Ω–∞ –∫–∞–º–ø—É—Å</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="node-count">0</div>
                <div class="stat-label">–£–∑–ª–æ–≤</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="building-entrance-count">0</div>
                <div class="stat-label">–í—Ö–æ–¥–æ–≤ –≤ –∫–æ—Ä–ø—É—Å–∞</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="medical-count">0</div>
                <div class="stat-label">–ú–µ–¥–ø—É–Ω–∫—Ç–æ–≤</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="road-count">0</div>
                <div class="stat-label">–î–æ—Ä–æ–≥</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-success" onclick="setMode('entrance')">üö™ –î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥</button>
            <button class="btn-primary" onclick="setMode('node')">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª</button>
            <button class="btn-primary" onclick="setMode('buildingEntrance')">üè¢ –í—Ö–æ–¥ –≤ –∫–æ—Ä–ø—É—Å</button>
            <button class="btn-primary" onclick="setMode('building')">üè´ –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–æ—Ä–ø—É—Å</button>
            <button class="btn-danger" onclick="setMode('medicalPoint')">üè• –ú–µ–¥–ø—É–Ω–∫—Ç</button>
            <button class="btn-primary" onclick="setMode('road')">üõ£Ô∏è –†–∏—Å–æ–≤–∞—Ç—å –¥–æ—Ä–æ–≥–∏</button>
            <button class="btn-danger" onclick="setMode('deleteRoad')">‚ùå –£–¥–∞–ª–∏—Ç—å –¥–æ—Ä–æ–≥—É</button>
            <button class="btn-danger" onclick="setMode('deletePoint')">‚ùå –£–¥–∞–ª–∏—Ç—å —Ç–æ—á–∫—É</button>
            <button class="btn-secondary" onclick="setMode('view')">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
            <button class="btn-secondary" onclick="clearAll()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            <button class="btn-success" onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>

        <div class="map-container">
            <svg id="editor-svg" viewBox="0 0 1024 520" xmlns="http://www.w3.org/2000/svg">
                <image href="https://raw.githubusercontent.com/nishikiken/campus-navigator/main/campus_bot/mini_app/frontend/campus-map.png" width="1024" height="520" preserveAspectRatio="xMidYMid meet"/>
                
                <!-- –ö–æ—Ä–ø—É—Å–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏) -->
                <g id="buildings-layer">
                    <g class="building-marker" data-building="1">
                        <circle cx="450" cy="175" r="20" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="450" y="183" text-anchor="middle" fill="#fff" font-size="20" font-weight="bold">1</text>
                    </g>
                    <g class="building-marker" data-building="2">
                        <circle cx="444" cy="376" r="18" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="444" y="384" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">2</text>
                    </g>
                    <g class="building-marker" data-building="3">
                        <circle cx="510" cy="387" r="18" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="510" y="395" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">3</text>
                    </g>
                    <g class="building-marker" data-building="4">
                        <circle cx="421" cy="478" r="18" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="421" y="486" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">4</text>
                    </g>
                    <g class="building-marker" data-building="5">
                        <circle cx="678" cy="174" r="18" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="678" y="182" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">5</text>
                    </g>
                    <g class="building-marker" data-building="6">
                        <circle cx="149" cy="241" r="18" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="149" y="249" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">6</text>
                    </g>
                    <g class="building-marker" data-building="7">
                        <circle cx="149" cy="157" r="18" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="149" y="165" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">7</text>
                    </g>
                    <g class="building-marker" data-building="8">
                        <circle cx="293" cy="198" r="18" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="293" y="206" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">8</text>
                    </g>
                    <g class="building-marker" data-building="9">
                        <circle cx="640" cy="351" r="18" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="640" y="359" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">9</text>
                    </g>
                    <g class="building-marker" data-building="10">
                        <circle cx="576" cy="207" r="19" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="576" y="215" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">10</text>
                    </g>
                    <g class="building-marker" data-building="11">
                        <circle cx="609" cy="418" r="19" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="609" y="426" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">11</text>
                    </g>
                    <g class="building-marker" data-building="12">
                        <circle cx="510" cy="67" r="19" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="510" y="75" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">12</text>
                    </g>
                    <g class="building-marker" data-building="19">
                        <circle cx="709" cy="406" r="19" fill="#0d6efd" stroke="#fff" stroke-width="2.5"/>
                        <text x="709" y="414" text-anchor="middle" fill="#fff" font-size="17" font-weight="bold">19</text>
                    </g>
                </g>
                
                <!-- –°–ª–æ–π –¥–ª—è –¥–æ—Ä–æ–≥ -->
                <g id="roads-layer"></g>
                
                <!-- –°–ª–æ–π –¥–ª—è —Ç–æ—á–µ–∫ (–≤—Ö–æ–¥—ã –∏ —É–∑–ª—ã) -->
                <g id="points-layer"></g>
                
                <!-- –í—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è –ø—Ä–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–∏ -->
                <line id="temp-line" class="temp-line" style="display:none;"/>
            </svg>
        </div>

        <div class="output">
            <h3>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥:</h3>
            <textarea id="output-code" readonly placeholder="–ù–∞–∂–º–∏ '–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å' —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥..."></textarea>
        </div>
    </div>

    <script>
        let mode = 'view';
        let entrances = [];
        let nodes = [];
        let buildingEntrances = [];
        let medicalPoints = [];
        let roads = [];
        let selectedPoint = null;
        let entranceCounter = 1;
        let nodeCounter = 1;
        let buildingEntranceCounter = 1;
        let medicalPointCounter = 1;

        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–æ—Ä–ø—É—Å–æ–≤ (–¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —Å –¥–æ—Ä–æ–≥–∞–º–∏)
        const buildings = {
            1: { x: 450, y: 175 },
            2: { x: 444, y: 376 },
            3: { x: 510, y: 387 },
            4: { x: 421, y: 478 },
            5: { x: 678, y: 174 },
            6: { x: 149, y: 241 },
            7: { x: 149, y: 157 },
            8: { x: 293, y: 198 },
            9: { x: 640, y: 351 },
            10: { x: 576, y: 207 },
            11: { x: 609, y: 418 },
            12: { x: 510, y: 67 },
            19: { x: 709, y: 406 }
        };

        function setMode(newMode) {
            mode = newMode;
            selectedPoint = null;
            document.getElementById('temp-line').style.display = 'none';
            
            const indicator = document.getElementById('mode-indicator');
            indicator.className = 'mode-indicator ' + newMode;
            
            const modeNames = {
                view: '–ü—Ä–æ—Å–º–æ—Ç—Ä',
                entrance: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ö–æ–¥–∞ –Ω–∞ –∫–∞–º–ø—É—Å (–∫–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–µ)',
                node: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–∑–ª–∞ (–∫–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–µ)',
                buildingEntrance: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ö–æ–¥–∞ –≤ –∫–æ—Ä–ø—É—Å (–∫–ª–∏–∫–Ω–∏ –≥–¥–µ –¥–≤–µ—Ä—å)',
                building: '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–æ—Ä–ø—É—Å–∞ (–∫–ª–∏–∫–Ω–∏ –Ω–∞ –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ)',
                medicalPoint: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–ø—É–Ω–∫—Ç–∞ (–∫–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–µ)',
                road: '–†–∏—Å–æ–≤–∞–Ω–∏–µ –¥–æ—Ä–æ–≥–∏ (–∫–ª–∏–∫–∞–π –ø–æ —Ç–æ—á–∫–∞–º)',
                deleteRoad: '–£–¥–∞–ª–µ–Ω–∏–µ –¥–æ—Ä–æ–≥–∏ (–∫–ª–∏–∫–Ω–∏ –Ω–∞ –ª–∏–Ω–∏—é)',
                deletePoint: '–£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏ (–∫–ª–∏–∫–Ω–∏ –Ω–∞ —Ç–æ—á–∫—É)'
            };
            
            indicator.textContent = '–†–µ–∂–∏–º: ' + modeNames[newMode];
        }

        function getSVGCoordinates(event) {
            const svg = document.getElementById('editor-svg');
            const pt = svg.createSVGPoint();
            pt.x = event.clientX;
            pt.y = event.clientY;
            const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
            return { x: Math.round(svgP.x), y: Math.round(svgP.y) };
        }

        document.getElementById('editor-svg').addEventListener('click', function(e) {
            if (e.target.id === 'editor-svg' || e.target.tagName === 'image') {
                if (mode === 'entrance') {
                    addEntrance(e);
                } else if (mode === 'node') {
                    addNode(e);
                } else if (mode === 'buildingEntrance') {
                    addBuildingEntrance(e);
                } else if (mode === 'medicalPoint') {
                    addMedicalPoint(e);
                } else if (mode === 'building') {
                    moveBuilding(e);
                }
            }
        });

        function moveBuilding(event) {
            const buildingId = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ—Ä–ø—É—Å–∞ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (1, 2, 3... 19):');
            if (!buildingId || !buildings[buildingId]) {
                alert('–ö–æ—Ä–ø—É—Å –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            
            const coords = getSVGCoordinates(event);
            buildings[buildingId] = { x: coords.x, y: coords.y };
            renderPoints();
        }

        function addEntrance(event) {
            const coords = getSVGCoordinates(event);
            const id = 'entrance' + entranceCounter++;
            entrances.push({ id, x: coords.x, y: coords.y });
            renderPoints();
            updateStats();
        }

        function addNode(event) {
            const coords = getSVGCoordinates(event);
            const id = 'n' + nodeCounter++;
            nodes.push({ id, x: coords.x, y: coords.y });
            renderPoints();
            updateStats();
        }

        function addBuildingEntrance(event) {
            const coords = getSVGCoordinates(event);
            const buildingNum = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ—Ä–ø—É—Å–∞ –¥–ª—è —ç—Ç–æ–≥–æ –≤—Ö–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1, 2, 6, 7, 19):');
            if (!buildingNum) return;
            
            const id = 'be' + buildingNum;
            buildingEntrances.push({ id, x: coords.x, y: coords.y, building: buildingNum });
            renderPoints();
            updateStats();
        }

        function addMedicalPoint(event) {
            const coords = getSVGCoordinates(event);
            const id = 'med' + medicalPointCounter++;
            medicalPoints.push({ id, x: coords.x, y: coords.y });
            renderPoints();
            updateStats();
        }

        function renderPoints() {
            const layer = document.getElementById('points-layer');
            layer.innerHTML = '';
            
            // –†–∏—Å—É–µ–º –≤—Ö–æ–¥—ã (–∑–µ–ª–µ–Ω—ã–µ)
            entrances.forEach(point => {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.classList.add('point-marker');
                g.setAttribute('data-id', point.id);
                g.onclick = () => handlePointClick(point.id);
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', 5);
                circle.setAttribute('fill', '#34c759');
                circle.setAttribute('stroke', '#fff');
                circle.setAttribute('stroke-width', 1);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', point.x);
                text.setAttribute('y', point.y + 2);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#fff');
                text.setAttribute('font-size', 7);
                text.setAttribute('font-weight', 'bold');
                text.textContent = point.id.replace('entrance', 'E');
                
                g.appendChild(circle);
                g.appendChild(text);
                layer.appendChild(g);
            });
            
            // –†–∏—Å—É–µ–º —É–∑–ª—ã (–æ—Ä–∞–Ω–∂–µ–≤—ã–µ)
            nodes.forEach(point => {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.classList.add('point-marker');
                g.setAttribute('data-id', point.id);
                g.onclick = () => handlePointClick(point.id);
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', 3);
                circle.setAttribute('fill', '#ff9500');
                circle.setAttribute('stroke', '#fff');
                circle.setAttribute('stroke-width', 1);
                
                g.appendChild(circle);
                layer.appendChild(g);
            });
            
            // –†–∏—Å—É–µ–º –≤—Ö–æ–¥—ã –≤ –∫–æ—Ä–ø—É—Å–∞ (—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ –∫–≤–∞–¥—Ä–∞—Ç—ã —Å –Ω–æ–º–µ—Ä–∞–º–∏)
            buildingEntrances.forEach(point => {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.classList.add('point-marker');
                g.setAttribute('data-id', point.id);
                g.onclick = () => handlePointClick(point.id);
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', point.x - 5);
                rect.setAttribute('y', point.y - 5);
                rect.setAttribute('width', 10);
                rect.setAttribute('height', 10);
                rect.setAttribute('fill', '#af52de');
                rect.setAttribute('stroke', '#fff');
                rect.setAttribute('stroke-width', 1);
                rect.setAttribute('rx', 1);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', point.x);
                text.setAttribute('y', point.y + 2);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#fff');
                text.setAttribute('font-size', 7);
                text.setAttribute('font-weight', 'bold');
                text.textContent = point.building || point.id.replace('be', '');
                
                g.appendChild(rect);
                g.appendChild(text);
                layer.appendChild(g);
            });
            
            // –†–∏—Å—É–µ–º –º–µ–¥–ø—É–Ω–∫—Ç—ã (–∫—Ä–∞—Å–Ω—ã–µ –∫—Ä–µ—Å—Ç—ã)
            medicalPoints.forEach(point => {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.classList.add('point-marker');
                g.setAttribute('data-id', point.id);
                g.onclick = () => handlePointClick(point.id);
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', 5);
                circle.setAttribute('fill', '#ff3b30');
                circle.setAttribute('stroke', '#fff');
                circle.setAttribute('stroke-width', 1);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', point.x);
                text.setAttribute('y', point.y + 3);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#fff');
                text.setAttribute('font-size', 9);
                text.setAttribute('font-weight', 'bold');
                text.textContent = '+';
                
                g.appendChild(circle);
                g.appendChild(text);
                layer.appendChild(g);
            });
            
            // –†–∏—Å—É–µ–º –∫–æ—Ä–ø—É—Å–∞ (—Å–∏–Ω–∏–µ –∫—Ä—É–≥–∏ —Å –Ω–æ–º–µ—Ä–∞–º–∏)
            Object.keys(buildings).forEach(buildingId => {
                const point = buildings[buildingId];
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.classList.add('point-marker');
                g.setAttribute('data-id', buildingId);
                g.onclick = () => handlePointClick(buildingId);
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', 8);
                circle.setAttribute('fill', '#0d6efd');
                circle.setAttribute('stroke', '#fff');
                circle.setAttribute('stroke-width', 1);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', point.x);
                text.setAttribute('y', point.y + 3);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#fff');
                text.setAttribute('font-size', 8);
                text.setAttribute('font-weight', 'bold');
                text.textContent = buildingId;
                
                g.appendChild(circle);
                g.appendChild(text);
                layer.appendChild(g);
            });
        }

        function handlePointClick(pointId) {
            if (mode === 'road') {
                if (!selectedPoint) {
                    selectedPoint = pointId;
                    showTempLine(pointId);
                } else {
                    if (selectedPoint !== pointId) {
                        addRoad(selectedPoint, pointId);
                    }
                    selectedPoint = null;
                    document.getElementById('temp-line').style.display = 'none';
                }
            } else if (mode === 'deletePoint') {
                deletePoint(pointId);
            }
        }

        function showTempLine(fromId) {
            const from = getPointCoords(fromId);
            const tempLine = document.getElementById('temp-line');
            tempLine.setAttribute('x1', from.x);
            tempLine.setAttribute('y1', from.y);
            tempLine.style.display = 'block';
            
            document.getElementById('editor-svg').onmousemove = function(e) {
                if (mode === 'road' && selectedPoint) {
                    const coords = getSVGCoordinates(e);
                    tempLine.setAttribute('x2', coords.x);
                    tempLine.setAttribute('y2', coords.y);
                }
            };
        }

        function getPointCoords(id) {
            const entrance = entrances.find(p => p.id === id);
            if (entrance) return entrance;
            const node = nodes.find(p => p.id === id);
            if (node) return node;
            const buildingEntrance = buildingEntrances.find(p => p.id === id);
            if (buildingEntrance) return buildingEntrance;
            const medicalPoint = medicalPoints.find(p => p.id === id);
            if (medicalPoint) return medicalPoint;
            const building = Object.keys(buildings).find(b => b === id);
            if (building) return buildings[building];
            return null;
        }

        function addRoad(from, to) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –¥–æ—Ä–æ–≥–∏
            const exists = roads.some(r => 
                (r.from === from && r.to === to) || (r.from === to && r.to === from)
            );
            if (!exists) {
                roads.push({ from, to });
                renderRoads();
                updateStats();
            }
        }

        function renderRoads() {
            const layer = document.getElementById('roads-layer');
            layer.innerHTML = '';
            
            roads.forEach((road, index) => {
                const fromCoords = getPointCoords(road.from);
                const toCoords = getPointCoords(road.to);
                
                if (fromCoords && toCoords) {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.classList.add('road-line');
                    line.setAttribute('x1', fromCoords.x);
                    line.setAttribute('y1', fromCoords.y);
                    line.setAttribute('x2', toCoords.x);
                    line.setAttribute('y2', toCoords.y);
                    line.setAttribute('data-index', index);
                    line.onclick = () => {
                        if (mode === 'deleteRoad') {
                            deleteRoad(index);
                        }
                    };
                    layer.appendChild(line);
                }
            });
        }

        function deleteRoad(index) {
            roads.splice(index, 1);
            renderRoads();
            updateStats();
        }

        function deletePoint(pointId) {
            // –£–¥–∞–ª—è–µ–º —Ç–æ—á–∫—É
            entrances = entrances.filter(p => p.id !== pointId);
            nodes = nodes.filter(p => p.id !== pointId);
            buildingEntrances = buildingEntrances.filter(p => p.id !== pointId);
            medicalPoints = medicalPoints.filter(p => p.id !== pointId);
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –¥–æ—Ä–æ–≥–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —ç—Ç–æ–π —Ç–æ—á–∫–æ–π
            roads = roads.filter(r => r.from !== pointId && r.to !== pointId);
            
            renderPoints();
            renderRoads();
            updateStats();
        }

        function clearAll() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏ –∏ –¥–æ—Ä–æ–≥–∏?')) {
                entrances = [];
                nodes = [];
                buildingEntrances = [];
                medicalPoints = [];
                roads = [];
                entranceCounter = 1;
                nodeCounter = 1;
                buildingEntranceCounter = 1;
                medicalPointCounter = 1;
                renderPoints();
                renderRoads();
                updateStats();
            }
        }

        function updateStats() {
            document.getElementById('entrance-count').textContent = entrances.length;
            document.getElementById('node-count').textContent = nodes.length;
            document.getElementById('building-entrance-count').textContent = buildingEntrances.length;
            document.getElementById('medical-count').textContent = medicalPoints.length;
            document.getElementById('road-count').textContent = roads.length;
        }

        function exportData() {
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç coordinates
            let coordsCode = '// –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤\nconst coordinates = {\n';
            
            // –í—Ö–æ–¥—ã
            entrances.forEach(e => {
                coordsCode += `    ${e.id}: { x: ${e.x}, y: ${e.y} },\n`;
            });
            
            // –ö–æ—Ä–ø—É—Å–∞
            Object.keys(buildings).forEach(b => {
                coordsCode += `    ${b}: { x: ${buildings[b].x}, y: ${buildings[b].y} },\n`;
            });
            
            // –£–∑–ª—ã
            nodes.forEach(n => {
                coordsCode += `    ${n.id}: { x: ${n.x}, y: ${n.y} },\n`;
            });
            
            // –í—Ö–æ–¥—ã –≤ –∫–æ—Ä–ø—É—Å–∞
            buildingEntrances.forEach(be => {
                coordsCode += `    ${be.id}: { x: ${be.x}, y: ${be.y} },\n`;
            });
            
            // –ú–µ–¥–ø—É–Ω–∫—Ç—ã
            medicalPoints.forEach(med => {
                coordsCode += `    ${med.id}: { x: ${med.x}, y: ${med.y} },\n`;
            });
            
            coordsCode += '};\n\n';
            
            // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ –ø—É—Ç–µ–π
            let graphCode = '// –ì—Ä–∞—Ñ –ø—É—Ç–µ–π (–∫–∞–∫–∏–µ —Ç–æ—á–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω—ã –¥–æ—Ä–æ–≥–∞–º–∏)\nconst pathGraph = {\n';
            
            // –°–æ–±–∏—Ä–∞–µ–º —Å–≤—è–∑–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏
            const connections = {};
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ç–æ—á–∫–∏
            entrances.forEach(e => connections[e.id] = []);
            nodes.forEach(n => connections[n.id] = []);
            buildingEntrances.forEach(be => connections[be.id] = []);
            medicalPoints.forEach(med => connections[med.id] = []);
            Object.keys(buildings).forEach(b => connections[b] = []);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–≤—è–∑–∏ –∏–∑ –¥–æ—Ä–æ–≥
            roads.forEach(road => {
                if (!connections[road.from]) connections[road.from] = [];
                if (!connections[road.to]) connections[road.to] = [];
                connections[road.from].push(road.to);
                connections[road.to].push(road.from);
            });
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥
            Object.keys(connections).forEach(point => {
                const conn = connections[point].map(c => `'${c}'`).join(', ');
                graphCode += `    ${point}: [${conn}],\n`;
            });
            
            graphCode += '};\n';
            
            const fullCode = coordsCode + graphCode;
            document.getElementById('output-code').value = fullCode;
            
            alert('–ö–æ–¥ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω! –°–∫–æ–ø–∏—Ä—É–π –µ–≥–æ –∏ –∑–∞–º–µ–Ω–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —á–∞—Å—Ç–∏ –≤ map-script.js');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateStats();
    </script>
</body>
</html>
